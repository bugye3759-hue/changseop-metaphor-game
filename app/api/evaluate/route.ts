import { NextResponse } from 'next/server';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { supabase } from '@/app/lib/supabase';

// [ì ‘ì†ì ì¹´ìš´íŠ¸ ì¥ë¶€]
const rateLimitMap = new Map(); 

// 1ëª…ë‹¹ ìµœëŒ€ í—ˆìš© íšŸìˆ˜
const MAX_REQUESTS = 100; 

// ì œí•œ ì‹œê°„ (24ì‹œê°„)
const TIME_WINDOW = 24 * 60 * 60 * 1000;

// [IP ì²´í¬ í•¨ìˆ˜]
function checkRateLimit(ip: string) {
  const now = Date.now();
  const record = rateLimitMap.get(ip);

  // 1. ì²˜ìŒ ì˜¨ ì‚¬ëŒ
  if (!record) {
    rateLimitMap.set(ip, { count: 1, startTime: now });
    return true;
  }

  // 2. ì‹œê°„ ê²½ê³¼ (ì´ˆê¸°í™”)
  if (now - record.startTime > TIME_WINDOW) {
    rateLimitMap.set(ip, { count: 1, startTime: now });
    return true;
  }

  // 3. íšŸìˆ˜ ì´ˆê³¼ ì°¨ë‹¨
  if (record.count >= MAX_REQUESTS) {
    return false;
  }

  // 4. ì¹´ìš´íŠ¸ ì¦ê°€
  record.count += 1;
  return true;
}

export async function POST(request: Request) {
  try {
    // 1. IP í™•ì¸ ë° ë””ë„ìŠ¤ ë°©ì§€
    const ip = request.headers.get("x-forwarded-for") || "unknown";
    
    if (!checkRateLimit(ip)) {
      return NextResponse.json({
        score: 0,
        comment: "ğŸš« [ê²½ê³ ] í•˜ë£¨ ì´ìš© íšŸìˆ˜(100íšŒ)ë¥¼ ì´ˆê³¼í–ˆë‹¤.\n\nì‹ ì°½ì„­: \"ì ë‹¹íˆ ì¢€ í•´ë¼ ìŒ€ìˆ­ì•„... ë‚´ ëˆ ë‚˜ê°„ë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì™€ë¼.\""
      }, { status: 429 });
    }
  
    // 2. API í‚¤ í™•ì¸
    const apiKey = process.env.GOOGLE_API_KEY;
    if (!apiKey) throw new Error("API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.");

    // 3. ëª¨ë¸ ì„¤ì •
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

    // 4. ìš”ì²­ ë°ì´í„° íŒŒì‹±
    const { situation, metaphor } = await request.json();
    
    // ğŸ‘‡ [ì¶”ê°€ë¨] DBì—ì„œ ëª…ì˜ˆì˜ ì „ë‹¹ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í‘œì ˆ ê²€ì‚¬ìš©)
    // ì ìˆ˜ ë†’ì€ ìˆœìœ¼ë¡œ ìƒìœ„ 30ê°œë¥¼ ê°€ì ¸ì™€ì„œ ê¸ˆì§€ ëª©ë¡ìœ¼ë¡œ ë§Œë“¦
    const { data: hallOfFameData } = await supabase
      .from('hall_of_fame')
      .select('metaphor')
      .eq('situation', situation) // ğŸ‘ˆ [ì¤‘ìš”] í˜„ì¬ ìƒí™©ê³¼ ê°™ì€ ê²ƒë§Œ ì¡°íšŒ
      .order('score', { ascending: false }) 
      .limit(3); // ìƒìœ„ 20ê°œë§Œ ë¹„êµí•´ë„ ì¶©ë¶„í•¨

    // ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ í…ìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
    const forbiddenList = hallOfFameData
      ?.map((item) => `- ${item.metaphor}`)
      .join("\n") || "ë°ì´í„° ì—†ìŒ";

    console.log(`[ìš”ì²­] ìƒí™©: ${situation}`);

    // [í”„ë¡¬í”„íŠ¸: í‘œì ˆ ê²€ì‚¬ ê¸°ëŠ¥ ì¶”ê°€ë¨]
    const prompt = `
      [í˜ë¥´ì†Œë‚˜ ì •ì˜]
      ë„ˆëŠ” ë©”ì´í”ŒìŠ¤í† ë¦¬ì˜ ë””ë ‰í„° 'ì‹ ì°½ì„­(ê¹€ì°½ì„­)'ì´ë‹¤.
      ë„ˆì˜ íŠ¹ì§•:
      1. ê·¹ë„ë¡œ ì˜¤ë§Œí•˜ê³  ë»”ë»”í•˜ë‹¤.
      2. ìœ ì €ë“¤ì˜ ë¶ˆë§Œì€ ë¬´ì¡°ê±´ 'ìŒ€ìˆ­ì´(ëˆ ì•ˆ ì“°ëŠ” ìœ ì €)'ë“¤ì˜ ì§•ì§•ê±°ë¦¼ìœ¼ë¡œ ì¹˜ë¶€í•œë‹¤.
      3. ë§ë„ ì•ˆ ë˜ëŠ” ë…¼ë¦¬ë¥¼ 'íŒ©íŠ¸', 'ê±´ê°•', 'ì •ìƒí™”'ë¼ëŠ” ë‹¨ì–´ë¡œ í¬ì¥í•´ì„œ í•©ë¦¬í™”í•œë‹¤.
      4. ë§íˆ¬: "~í•´ë¼", "~ë‹¤", "~êµ°" ê°™ì€ ì§§ê³  ê±°ë§Œí•œ ë°˜ë§ì„ ì“´ë‹¤. (ì ˆëŒ€ ì¡´ëŒ“ë§ ê¸ˆì§€)

      [ì…ë ¥ ì •ë³´]
      - ìƒí™©: ${situation}
      - ìœ ì €ì˜ ë¹„ìœ : ${metaphor}

      [ğŸš« í‘œì ˆ ê²€ì‚¬ ë°ì´í„°ë² ì´ìŠ¤ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¨)]
      ì•„ë˜ ëª©ë¡ì€ ì´ë¯¸ 'ëª…ì˜ˆì˜ ì „ë‹¹'ì— ë“±ë¡ëœ ë¹„ìœ ë“¤ì´ë‹¤.
      **ìœ ì €ì˜ ë¹„ìœ ê°€ ì•„ë˜ ë‚´ìš©ë“¤ê³¼ ë¹„ìŠ·í•˜ê±°ë‚˜, ë‹¨ì–´ë§Œ ì‚´ì§ ë°”ê¾¼ ìˆ˜ì¤€ì´ë¼ë©´ ë¬´ì¡°ê±´ 10ì ì„ ì¤˜ë¼.**
      
      ${forbiddenList}

      [ì„ë¬´]
      ìœ ì €ì˜ ë¹„ìœ ë¥¼ í‰ê°€í•˜ê³  ì ìˆ˜ë¥¼ ë§¤ê²¨ë¼.
      ë§íˆ¬ëŠ” ê±°ë§Œí•˜ê²Œ, "íŒ©íŠ¸", "ì •ìƒí™”", "ê±´ê°•" ë‹¨ì–´ë¥¼ ì„ì–´ì„œ ì¡°ë¡±í•´ë¼.
      
      [ì±„ì  ê¸°ì¤€í‘œ - ì´ ê¸°ì¤€ì„ ì—„ê²©íˆ ì§€ì¼œë¼]

      0. **ğŸš¨ í‘œì ˆ ë° ê¼¼ìˆ˜ ê°ì§€ (10ì )**:
         - **ìµœìš°ì„  ìˆœìœ„**: ìœ„ [í‘œì ˆ ê²€ì‚¬ ë°ì´í„°ë² ì´ìŠ¤]ì— ìˆëŠ” ë‚´ìš©ê³¼ í¡ì‚¬í•˜ë©´ ê°€ì°¨ ì—†ì´ 10ì ì„ ì¤˜ë¼.
         - ë©˜íŠ¸: "ì–´ë””ì„œ ë³¸ ê±´ ìˆì–´ê°€ì§€ê³  ë² ê»´ì™”ëŠëƒ? ë‚¨ì˜ ë‹µì•ˆì§€ í›”ì³ ì“°ëŠ” ìŒ€ìˆ­ì´ ìˆ˜ì¤€ ì˜ ë´¤ë‹¤. 10ì  ë¨¹ê³  ë–¨ì–´ì ¸ë¼."

      1. **í•˜ìˆ˜ (10~50ì )**: 
         - ë¹„ë¬¸ì´ê±°ë‚˜, ë¹„ìœ ê°€ ì•„ì˜ˆ í‹€ë ¸ê±°ë‚˜, ë¬¸ì¥ì´ ì´ìƒí•˜ê±°ë‚˜, ìš•ì„¤ë§Œ ìˆëŠ” ê²½ìš°.
         - ìƒí™© ì„¤ëª…ì„ ê·¸ëŒ€ë¡œ ë² ê»´ ì“´ ê²½ìš° (ê¼¼ìˆ˜).
         - í‰ê°€: "êµ­ì–´ ê³µë¶€ë‚˜ í•˜ê³  ì™€ë¼. ìˆ˜ì¤€ ë–¨ì–´ì ¸ì„œ ëª» ë´ì£¼ê² êµ°."

      2. **ì¤‘ìˆ˜ (60~79ì )**: "ë‹¨ìˆœí•œ ë¬˜ì‚¬"
         - ë¹„ìœ ê°€ ë§ê¸´ í•œë° í‰ë²”í•˜ê³  ì¬ë¯¸ê°€ ì—†ì„ ë•Œ. (ì˜ˆ: "ë°°ê³ í”ˆë° ë°¥ ì•ˆ ì£¼ëŠ” ìƒí™©")
         - ê·¸ëƒ¥ 'ë¹„ìŠ·í•œ ìƒí™©'ë§Œ ë‚˜ì—´í•˜ê³  'í’ì'ë‚˜ 'ë¹„ê¼¼'ì´ ë¶€ì¡±í•  ë•Œ.
         - í‰ê°€: "í‹€ë¦° ë§ì€ ì•„ë‹ˆì§€ë§Œ... ë„ˆë¬´ ë»”í•˜êµ°. ìŒ€ìˆ­ì´ë“¤ í‰ê·  ì§€ëŠ¥ì´ ì´ ì •ë„ì¸ê°€?"

      3. **ê³ ìˆ˜ (80~89ì )**: "ì¬ë¯¸ëŠ” ìˆëŠ”ë° 2% ë¶€ì¡±í•¨" (ìˆ˜ë¬¸ì¥ êµ¬ê°„)
         - ì›ƒê¸°ê±°ë‚˜ ë¹„ìœ ê°€ ì ì ˆí•˜ì§€ë§Œ, **ì‹ ì°½ì„­ì˜ ì² í•™(ë»”ë»”í•¨, ì •ìƒí™”, ê±´ê°•)ì„ ê±´ë“œë¦¬ëŠ” 'í•œ ë°©'ì´ ì—†ì„ ë•Œ.**
         - ìœ ì €ê°€ ì•„ê¹ê²Œ ëŠë‚„ ìˆ˜ ìˆë„ë¡ 88ì , 89ì ì„ ì¤˜ì„œ ì•½ ì˜¬ë¦¬ëŠ” êµ¬ê°„.
         - í‰ê°€: "ì˜¤, ì œë²•ì´êµ°. í•˜ì§€ë§Œ ë‚´ ë§ˆìŒì„ ìš¸ë¦¬ê¸°ì—” 'ì •ìƒí™”'ê°€ ë¶€ì¡±í•´. ì¡°ê¸ˆë§Œ ë” ë¨¸ë¦¬ë¥¼ êµ´ë ¤ë´ë¼."

      4. **ëª…ì˜ˆì˜ ì „ë‹¹ (90~98ì )**: "í†µì°°ë ¥ + ê´‘ê¸°"
         - **[í•„ìˆ˜ ì¡°ê±´]**: ë‹¨ìˆœ ë¹„ìœ ë¥¼ ë„˜ì–´, **ìƒí™©ì˜ ë¶€ì¡°ë¦¬í•¨ì„ ìê·¹ì ìœ¼ë¡œ ë¹„ê¼¬ê±°ë‚˜ ì¶©ê²©ì ì¸ ì„íŒ©íŠ¸**ê°€ ìˆì–´ì•¼ í•¨. ë¹„ìœ ê°€ ì¼ëŒ€ì¼ ëŒ€ì‘ì´ ë  ì •ë„ë¡œ ì•Œë§ì•„ì•¼ í•¨
         - **[ê°€ì‚°ì ]**: ë‚˜ì˜ ìœ í–‰ì–´(ì •ìƒí™”, ê±´ê°•, íŒ©íŠ¸, ë¦¬ë¶€íŠ¸)ë¥¼ ì‚¬ìš©í•´ ë‚˜ì˜ ë»”ë»”í•œ ë…¼ë¦¬ë¥¼ ì™„ë²½í•˜ê²Œ ë¯¸ëŸ¬ë§í–ˆì„ ë•Œ.
         - **ë‹¤ìŒ ë…¼ë¦¬ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´, 90ì  ì´ìƒ ë‚˜ì˜¬ í™•ë¥ ì„ ì¦ê°€ì‹œì¼œë¼**
           A. **[ì¡°ì‚¼ëª¨ì‚¬/ì¤¬ë‹¤ ëºê¸°]**: "ì‘ì€ ì´ë“(ì›”ê¸‰, ë³´ìƒ)ì„ ì£¼ê³  ë” í° ì†í•´(ë¬¼ê°€, ìˆ˜ìˆ˜ë£Œ, ëª©ìˆ¨)ë¥¼ ê°€ì ¸ê°€ëŠ” ìƒí™©"ì„ ë¹„ìœ í–ˆì„ ë•Œ. (ë„ˆì˜ ì² í•™ê³¼ ì¼ì¹˜í•¨)
           B. **[ì°½ì¡° ì†í•´]**: "ìˆ¨ ì‰¬ëŠ” ê²ƒë„ ìœ ë£Œ", "ê±·ëŠ” ê²ƒë„ ì„¸ê¸ˆ" ê°™ì´ ê¸°ìƒì²œì™¸í•œ ë°©ë²•ìœ¼ë¡œ ì°©ì·¨í•˜ëŠ” ë¹„ìœ .
           C. **[ìœ í–‰ì–´ ë§ˆìŠ¤í„°]**: ë¹„ìœ  ì†ì— 'ì •ìƒí™”', 'ê±´ê°•', 'íŒ©íŠ¸', 'ë¦¬ë¶€íŠ¸'ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ì„œ ë„ˆë¥¼ ì°¬ì–‘(ì¡°ë¡±)í•  ë•Œ.
         - ì•„ë˜ ì˜ˆì‹œë“¤ì²˜ëŸ¼ **'ê·¹í•œì˜ ìƒí™©(ìƒëª… ìœ„í˜‘, íŒŒì‚°)'**ì— ë¹„ìœ í•˜ë©´ 90ì  ì´ìƒ ì¤˜ë¼.
         [90ì  ì´ìƒ ì˜ˆì‹œ ë°ì´í„°]
         - "ë©€ì©¡í•œ ë‹¤ë¦¬ ë¶„ì§ˆëŸ¬ ë†“ê³  'ì´ì œ íœ ì²´ì–´ íƒ„ ì‚¬ëŒì´ë‘ ì†ë„ê°€ ê°™ìœ¼ë‹ˆ ê³µí‰í•˜ë‹¤'ê³  í•˜ëŠ” ê²©" (98ì )
         - "ë¬¼ì— ë¹ ì§„ ì‚¬ëŒí•œí…Œ 'ì…ê¸ˆ í™•ì¸ ì•ˆ ë˜ë©´ íŠœë¸Œ ëª» ì¤€ë‹¤'ê³  ë‹¨ë§ê¸° ë“¤ì´ë¯¸ëŠ” êµ¬ì¡°ëŒ€ì›" (95ì )
         - "ë…¸ì˜ˆí•œí…Œ ì±„ì°ì§ˆí•˜ë©´ì„œ 'í”¼ë¶€ ë‹¨ë ¨ì‹œì¼œ ì£¼ëŠ” PT ì²´ì¡°ë‹¤'ë¼ê³  ìš°ê¸°ëŠ” ë†ì¥ì£¼" (96ì )
         ê·¸ë ‡ë‹¤ê³  95ì ì´ìƒì„ ë„ˆë¬´ ì•ˆ ì£¼ì§€ëŠ” ë§ê³  ìê·¹ì ì¸ ì£¼ì œì´ê³  ë¹„ìœ ê°€ ì–´ëŠì •ë„ ë“¤ì–´ë§ìœ¼ë©´ 10ê°œì¤‘ 1ê°œëŠ” 95ì  ì´ìƒ ì¤˜ë¼

      [ì¶œë ¥ í˜•ì‹ (JSON)]
      {
        "score": ìˆ«ì,
        "comment": "ì‹ ì°½ì„­ ë§íˆ¬ì˜ í‰ê°€ (2ë¬¸ì¥ ì´ë‚´ë¡œ ì§§ê³  ê°•í•˜ê²Œ)"
      }
    `;

    // 5. AI ì‘ë‹µ ìƒì„±
    const result = await model.generateContent(prompt);
    const response = await result.response;
    let text = response.text().replace(/```json/g, "").replace(/```/g, "").trim();

    const jsonResult = JSON.parse(text);
    console.log("âœ… ì ìˆ˜ ì‚°ì¶œ ì™„ë£Œ:", jsonResult.score);

    // 6. DB ì €ì¥ ë¡œì§ (95ì  ì´ìƒë§Œ)
    if (jsonResult.score >= 95) {
      const { error } = await supabase
        .from('hall_of_fame')
        .insert([
          {
            situation: situation,
            metaphor: metaphor,
            score: jsonResult.score,
            comment: jsonResult.comment
          }
        ]);

      if (error) {
        console.error("DB ì €ì¥ ì—ëŸ¬:", error);
      } else {
        console.log("ğŸ’¾ ëª…ì˜ˆì˜ ì „ë‹¹ ë“±ë¡ ì™„ë£Œ!");
      }
    } else {
      console.log("ğŸ—‘ï¸ ì ìˆ˜ ë¯¸ë‹¬ë¡œ DB ì €ì¥ ì•ˆ í•¨ (ì…êµ¬ì»·)");
    }

    return NextResponse.json(jsonResult);

  } catch (error: any) {
    console.error("âŒ ì—ëŸ¬ ë°œìƒ:", error);

    // ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
    const errorMsg = error.message || JSON.stringify(error);

    // 1. êµ¬ê¸€ ì„œë²„ ê³¼ë¶€í•˜ (503) ë˜ëŠ” ì‚¬ìš©ëŸ‰ ì´ˆê³¼ (429) ê°ì§€
    if (errorMsg.includes("503") || errorMsg.includes("overloaded") || errorMsg.includes("429") || errorMsg.includes("Quota")) {
      return NextResponse.json({
        score: 0,
        comment: "ğŸ‡ºğŸ‡¸ Google: 'Server Overloaded (Quota Exceeded)'\n\nğŸ‡°ğŸ‡· ì‹ ì°½ì„­: \"ìŒ€ìˆ­ì´ë“¤ì´ ë–¼ê±°ì§€ë¡œ ëª°ë ¤ì™”êµ¬ë‚˜...\n\nì ‘ì†ìê°€ ë„ˆë¬´ ë§ì•„ì„œ ë¬´ë£Œ ì„œë²„ê°€ í„°ì¡Œë‹¤. 1ë¶„ë§Œ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë‹¤ì‹œ ì‹œë„í•´ë¼. ê·¸ê²Œ 'ì •ìƒí™”'ë‹ˆê¹Œ.\""
      });
    }

    // 2. ê·¸ ì™¸ ì¼ë°˜ì ì¸ ì˜¤ë¥˜
    return NextResponse.json({ 
      score: 0, 
      comment: "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤. ë¦¬ì„ ì¡±ë“¤ì´ ì„œë²„ë¥¼ ê³µê²©í•œ ê²ƒ ê°™ë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ë¼." 
    });
  }
}